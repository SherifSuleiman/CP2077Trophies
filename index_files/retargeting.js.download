(()=>{"use strict";let e,t,n,o;function r(e,t={}){const n={...t};return n.headers={...n.headers,"Anon-App-Version":"1.3.31"},fetch(e,n)}!function(e){e.IdwHydraHasErrorKey="IDW_HYDRA_HAS_ERROR",e.IdwCohortIdsKey="cohort_ids",e.idwScrollY="idw-scroll-y",e.IdwImpressionsKey="idw-impressions",e.anonymised="Anonymised",e.isOofUrl="idw-oof",e.idwOutdated="idw-outdated"}(e||(e={})),function(e){e.Quantcast="quantcast",e.Consentmanager="consentmanager",e.Liveramp="liveramp",e.Clickio="clickio",e.Sourcepoint="sourcepoint",e.Iubenda="iubenda",e.Uniconsent="uniconsent",e.OneTrust="onetrust",e.CookiePro="cookiepro",e.CookieBot="cookiebot",e.Googlefc="googlefc",e.Admiral="admiral",e.Ensighten="ensighten",e.CookieScript="cookiescript",e.Klaro="klaro",e.Civic="civic"}(t||(t={})),function(e){e.colorPrimary="idw_color_primary",e.errorReportingLevel="idw_error_reporting_level",e.cmpProvider="idw_cmp_provider",e.cmpProviderCookieGroup="idw_cmp_provider_cookie_group",e.environment="idw_environment",e.notIntegrateCmp="idw_not_integrate_cmp",e.overrideHasConsent="override_has_consent",e.softPrivacyRegulated="soft_privacy_regulated",e.hideButton="idw_hide_button",e.notLoginUser="not_login_user",e.retargetingOn="retargeting_on",e.gptTargetingOn="gpt_targeting_on",e.extendLoginToSubdomains="extend_login_to_subdomains",e.clientId="idw_client_id",e.loginExceptionPages="idw_login_exception_pages",e.loginInclusionPages="idw_login_inclusion_pages",e.immediateLoginPages="idw_immediate_login_pages",e.metricsRootUrl="idw_metrics_root_url",e.metricsCollectorUrl="idw_metrics_collector_url",e.retargetingScriptUrl="idw_retargeting_script_url",e.retargetingSegmentsUrl="idw_retargeting_segments_url",e.healthCheckUrl="idw_health_check_url",e.errorReportingUrl="idw_error_reporting_url",e.authority="idw_authority"}(n||(n={})),function(e){e.colorPrimary="color-primary",e.errorReportingLevel="error-reporting-level",e.cmpProvider="cmp-provider",e.cmpProviderCookieGroup="cmp-provider-cookie-group",e.environment="environment",e.notIntegrateCmp="not-integrate-cmp",e.overrideHasConsent="override-has-consent",e.softPrivacyRegulated="soft-privacy-regulated",e.hideButton="hide-button",e.notLoginUser="not-login-user",e.retargetingOn="retargeting-on",e.gptTargetingOn="gpt-targeting-on",e.extendLoginToSubdomains="extend-login-to-subdomains",e.clientId="client-id",e.loginExceptionPages="login-exception-pages",e.loginInclusionPages="login-inclusion-pages",e.immediateLoginPages="immediate-login-pages",e.loginInNewTab="login-in-new-tab",e.metricsRootUrl="metrics-root-url",e.metricsCollectorUrl="metrics-collector-url",e.retargetingScriptUrl="retargeting-script-url",e.retargetingSegmentsUrl="retargeting-segments-url",e.healthCheckUrl="health-check-url",e.errorReportingUrl="error-reporting-url",e.authority="authority",e.tagType="tag-type"}(o||(o={}));function i(){const e=Array.from(document.getElementsByTagName("script"));for(const t of e){const e=t.getAttribute("src");if(e&&e.includes("googletagmanager.com/gtm.js"))try{return new URLSearchParams(new URL(e).search).get("l")}catch(e){return null}}return null}function s(e,t,n){if(null==e||"object"!=typeof e)return!1;if(Object.hasOwnProperty.call(e,t)&&e[t]===n)return!0;for(const o in e)if(Object.hasOwnProperty.call(e,o)&&"object"==typeof e[o]&&null!==e[o]&&s(e[o],t,n))return!0;return!1}({maxScrollPosition:0,getMaxScroll:function(){return Math.round(this.maxScrollPosition)},updateMaxScroll:function(){const e=function(){const e=document.documentElement,t=document.body,n="scrollTop",o="scrollHeight";return(e[n]||t[n])/((e[o]||t[o])-e.clientHeight)*100||0}();e>this.maxScrollPosition&&(this.maxScrollPosition=e)},subscribeToScrollEvent:function(){window.addEventListener("scroll",(()=>{this.updateMaxScroll()}))}}).subscribeToScrollEvent();const a="dataLayer";function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const c=new class{constructor(){l(this,"observers",new Map),l(this,"dataLayerPushHandler",void 0),l(this,"lastNotifiedUrls",{oldUrl:"",newUrl:""}),l(this,"dataLayerName",void 0),this.dataLayerName=i()||a,this.dataLayerPushHandler=this.handleDataLayerPush.bind(this),window[this.dataLayerName]?this.overrideDataLayerPush():window.addEventListener(this.dataLayerName,this.overrideDataLayerPush.bind(this))}overrideDataLayerPush(){const e=window[this.dataLayerName].push;window[this.dataLayerName].push=(...t)=>{e.apply(window[this.dataLayerName],t),this.dataLayerPushHandler(t)}}handleDataLayerPush(e){if(e[0]&&e[0].event?.includes("gtm.historyChange")){const t=e[0],n=t["gtm.oldUrl"],o=t["gtm.newUrl"];this.lastNotifiedUrls.oldUrl===n&&this.lastNotifiedUrls.newUrl===o||(this.lastNotifiedUrls={oldUrl:n,newUrl:o},this.notifyObservers(n,o))}}notifyObservers(e,t){const n=Array.from(this.observers.values());for(const o of n)o(e,t)}addEventListener(e){const t=Symbol();return this.observers.set(t,e),t}removeEventListener(e){this.observers.delete(e)}},d="AnonRetargeting:",u="unsent-segments";let g=null;const m=document.currentScript;async function f(t){const n=m.getAttribute("idw_metrics_url");if(!n)return void console.warn(`${d} required script attribute idw_metrics_url is not defined!`);const o={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+g?.access_token},body:JSON.stringify({tag:t.uid}),keepalive:!0},{ok:i}=await r(n,o),s=function(e){try{return e.getAttribute("tag-type")||"publisher"}catch(e){return console.warn(`${d} Failed to get tag type from 'tag-type' attribute:`,e),"publisher"}}(m);if("publisher"===s&&i&&"published"===t.status)try{document.dispatchEvent(new CustomEvent("anonRetargetingSegmentAssigned",{detail:{tag:t.uid}}));const n=new Set(JSON.parse(localStorage.getItem(e.IdwCohortIdsKey))??[]);n.add(t.uid),localStorage.setItem(e.IdwCohortIdsKey,JSON.stringify(Array.from(n)))}catch(e){console.warn(`${d} segment assigned, but failed to update segment id in local storage:`,e)}}function p(){return new Set(JSON.parse(sessionStorage.getItem(u))??[])}async function h(){const e=m.getAttribute(o.retargetingSegmentsUrl);if(!e)return void console.warn(`${d} required script attribute ${o.retargetingSegmentsUrl} is not defined!`);const t=m.getAttribute("idw_authority"),n=Object.entries(localStorage).find((([e])=>e.startsWith(`oidc.user:${t}`)));if(g=n?JSON.parse(n[1]):null,function(e){return!e||e?.expires_at&&Math.round((new Date).getTime()/1e3)>=e.expires_at}(g))return void console.warn(`${d} auth token expired. Retargeting will start after OOF`);const l=p();l.forEach((async e=>{const t={uid:e};await f(t),l.delete(e),0===l.size?sessionStorage.removeItem(u):sessionStorage.setItem(u,JSON.stringify(Array.from(l)))}));const c=(await async function(e){const t={headers:{"Content-Type":"application/json",Authorization:"Bearer "+g.access_token}};try{const n=await r(e,t);if(!n.ok)throw new Error(`Failed to fetch segment definitions. Status: ${n.status}`);return await n.json()}catch(e){return console.warn(e),[]}}(e)).filter((e=>{return null===(t=e.definition).pages||0===t.pages.length||t.pages.some((e=>"contains"===e.condition.value?window.location.href.includes(e.value):function(e,t){const n=e=>e.replace(/^[^:]+:\/\/+/,"").replace(/\/$/,"").replace(/^www\./,"");return e===t||n(e)===n(t)}(window.location.href,e.value)));var t}));console.log(`${d} found ${c?.length??0} segment definitions for current page`),c.forEach((e=>{e.definition?.properties?.length>0?e.definition.properties.forEach((t=>{try{if("slotClicked"===t.event.value){const n=t.condition.value,o=t.value.toString();console.log(`${d} slotClicked '${n}=${o}' condition`);const r=new Set;window.googletag.cmd.push((function(){window.googletag.pubads().getSlots().forEach((t=>{const i=t.getSlotElementId(),s=document.getElementById(i);s&&!r.has(i)&&(s.addEventListener("click",(function(){const r=t.getResponseInformation();if(r){console.log(`${d} rs slotClicked event: ${n}:${r[n]}, val ${o}`);const t=r[n]?.toString();t===o&&f(e)}})),r.add(i))})),window.googletag.pubads().addEventListener("slotRenderEnded",(function(t){if(!t.isEmpty){const i=t.slot.getSlotElementId(),s=document.getElementById(i);s&&!r.has(i)&&(s.addEventListener("click",(function(){console.log(`${d} slotClicked event: ${n}:${t[n]}`),t[n]?.toString()===o&&f(e)})),r.add(i))}}))}))}else if("slotViewed"===t.event.value){const n=t.condition.value,o=t.value.toString();console.log(`${d} slotViewed '${n}=${o}' condition`),window.googletag.cmd.push((function(){window.googletag.pubads().getSlots().forEach((t=>{const r=t.getResponseInformation();if(r){const i=t.getSlotElementId();if(function(e){if(!e||!e.getBoundingClientRect)return!1;const t=e.getBoundingClientRect(),n=window.innerHeight||document.documentElement.clientHeight,o=window.innerWidth||document.documentElement.clientWidth;return t.top>=0&&t.left>=0&&t.bottom<=n&&t.right<=o}(document.getElementById(i))){console.log(`${d} rs slotViewed event: ${n}:${r[n]}, val ${o}`);const t=r[n]?.toString();t===o&&f(e)}}})),window.googletag.pubads().addEventListener("impressionViewable",(function(t){console.log(`${d} slotViewed event: ${n}:${t[n]}`),t[n]?.toString()===o&&f(e)}))}))}else if("dataLayer"===t.event.value){const n=t.condition.value,o=t.value;if(console.log(`${d} dataLayer '${n}=${o}' condition`),void 0!==n&&void 0!==o){const t=i()||a;console.log(`${d} GTM custom dataLayer key '${t}'`),Object.values(window[t]).some((e=>s(e,n,o)))&&f(e)}}else{console.log(`${d} selector ${t.value}, condition ${t.condition.value}`);const n="id"===t.condition.value?w(t.value)?[w(t.value)]:[]:function(e){const t=Array.from(document.querySelectorAll(e));if(t.length)return t;const n=Array.from(document.querySelectorAll("iframe"));for(const o of n)try{o?.contentDocument?.querySelectorAll&&t.push(...Array.from(o.contentDocument.querySelectorAll(e)))}catch(t){console.warn(`${d} failed to query selector ${e} in iframe ${o.src}:`,t?.message)}return t}(t.value);console.log(`${d} found ${n?.length??0} elements to subscribe to ${t.event.value} event. Segment definition ${e?.uid}`),n.forEach((n=>{n.addEventListener(t.event.value,(()=>{const t=p();t.add(e.uid),sessionStorage.setItem(u,JSON.stringify(Array.from(t))),f(e).then((()=>{const t=p();t.delete(e.uid),sessionStorage.setItem(u,JSON.stringify(Array.from(t)))}))}))}))}}catch(t){return void console.warn(`${d} failed parsing segment definition ${e.uid}:`,t?.message)}})):e.definition&&(console.log(`${d} Segment 'properties' blank. Assign user by the page view. Segment definition ${e.uid}`),f(e))}))}function w(e){const t=document.getElementById(e);if(t)return t;const n=Array.from(document.querySelectorAll("iframe"));for(const t of n)try{if(t?.contentDocument?.getElementById){const n=t.contentDocument.getElementById(e);if(n)return n}}catch(n){console.warn(`${d} failed to get element by id ${e} in iframe ${t.src}:`,n?.message)}return null}function y(){setTimeout((()=>h()),1e3)}c.addEventListener(((e,t)=>{console.log(`${d} SPA route changed from:`,e,"to:",t),y()})),"complete"===document.readyState||"interactive"===document.readyState?y():document.addEventListener("DOMContentLoaded",(()=>{y()}))})();